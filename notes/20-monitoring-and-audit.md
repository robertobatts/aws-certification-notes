# AWS Monitoring and Audit

## CloudWatch
### CloudWatch Metrics
- Cloudwatch provides metrics for every services in AWS
- Metrics belong to namespaces
- Dimension is an attribute of a metric (instance id, environment, etc...)
- Up to 10 dimensions per metric
- Metrics have timestamps
- Can create dashboards of metrics

#### EC2 Detailed monitoring
- EC2 instance metrics have metrics every 5 minutes
- With detailed monitoring (for a cost), you get data every 1 minute
- Use detailed monitoring if you want to scale faster for your ASG
- The AWS Free Tier allows us to have 10 detailed monitoring metrics
- Note: EC2 memory usage is by fedault not pushed (must be pushed from inside the instance as a custom metric)

### Custom Metrics
- Possibility to define and send your own custom metrics to CloudWatch
- Example: memory (RAM) usage, disk space, number of logged users, etc...
- Use API call PutMetricData
- Ability to use dimensions (attributes) to segment metrics
	- Instance.id
	- Environment.name
- Metric resolution (StorageResolution API parameter - two possible values)
	- Standard: 60 seconds
	- High resolution 1/5/10/30 seconds (higher cost)
- Important: Accepts metric data points two weeks in the past and two hours in the future, so when you create a new metric, make sure your ec2 instance time is correct in order to be syncronized with the other metrics in AWS

### Dashboards
- Setup custom dashboards for quick access to key metrics and alarms
- Dashboards are global
- Dashboards can include graphs from different AWS accounts and regions
- You can change the time zone and time range of the dashboards
- You can setup automatic refresh
- Dashboards can be shared with people who don't have an AWS account (public, email address, 3rd party SSO provider through Cognito)
- Pricing:
	- 3 dashboards (up to 50 metrics) for free
	- $3 per dashboard per month

### Logs
- **Log groups**: arbitrary name, usually representing an application
- **Log stream**: instances within application / log files / containers
- Can define log expiration policies
- CloudWatch Logs can send logs to:
	- S3 (exports)
	- Kinesis Data Streams
	- Kinesis Data Firehose
	- Lambda
	- ElasticSearch
- Sources:
	- SDK, CloudWatch Logs Agent, Unified Agent
	- Elastic Beanstalk
	- ECS
	- Lambda
	- VPC Flow Logs
	- API Gateway
	- CloudTrail based on filter
	- Route53

### Logs Metric Filter and Insights
- CloudWatch Logs can use filter expressions:
	- For example, find a specific IP inside of a log
	- Or count occurences of "ERROR" in your logs
- Metric filters can be used to trigger CloudWatch alarms
- CloudWatchLogs Insights can be used to query logs and add queries to CloudWatch Dashboards

### S3 Export
- Log data can take up to 12 hours to become available for export
- The API call is CreateExportTask
- Not near-real time or real-time, use Logs Subscription instead if you want that

### CloudWatch Agent and Logs Agent

#### Logs for EC2
- By default, no logs from you EC2 machine will go to CloudWatch
- You need to run a GloudWatch agent on EC2 to push the logs files you want
- Make sure IAM permissions are correct
- The CloudWatch log agent can be setup on-premises too

### Logs Agent and Unified Agent
- **CloudWatch Logs Agent**
	- Old version of the agent
	- Can only send to CloudWatch Logs
- **CloudWatch Unified Agent**
	- Collection additional system level metrics such as RAM, processors, etc...
	- Collect logs to send to CloudWatch Logs
	- Centralized configuration using SSM Parameter Store

### CloudWatch Alarms
- Alarms are used to trigger notifications for any metric
- Various options (sampling, %, max, min, etc...)
- Alarm States:
	- OK
	- INSUFFICIENT_DATA
	- ALARM
- Period:
	- Length of time in seconds to evaluate the metric
	- High resolution custom metrics: 10 sec, 30 sec or multiple of 60 sec

#### Alarm Targets
- Stop, Terminate, Reboot or Recover an EC2 instance
- Trigger Auto Scaling Action
- Send notification to SNS

## EventBridge (formerly CloudWatch Events)
- Schedule: Cron jobs (scheduled scripts)
- Event Pattern: Event rules to react to a service doing something
- Trigger Lambda functions, send SNS/SQS messages, etc...
- **Default Event Bus**: events generated by AWS services
- **Partner Event Bus**: receive events from SaaS or applications (Zendesk, Auth0, etc...)
- **Custom Event Buses**: for your own applications
- You can archive events sent to an event bus
- You can replay archived events

### Schema Registry
- EventBridge can analyze the events in your bus and infer the schema
- The Schema Registry allows you to generate the code for your application, that will know in advance how data is structured in the event bus
- Schema can be versioned

### Resource-based Policy
- Manage permissions for a specific Event Bus
- Example: allow/deny events from another AWS account or AWS region
- Use case: aggregate all events from your AWS Organization in a single AWS account or AWS region

## CloudTrail
- Provides governance, compliance and audit for your AWS Account
- CloudTrail is enabled by default
- Get an history of events/API calls made within your AWS Account by Console, SDK, CLI, AWS Services
- Can put logs from CloudTrail into CloudWatch Logs or S3
- A trail can be applied to All Regions (default) or a single Region
- If a resource is deleted in AWS, investigate CloudTrail first!

### CloudTrail Events
- **Management Events**:
	- Operations that are performed on resources in your account
	- By default, trails are configured to log management events
	- Can separate Read Events from Write Events
- **Data Events**:
	- By default, data events are not logged (because high volume operations), examples:
	- S3 object-level activity (GetObject, DeleteObject, PutObject)
	- Lambda function execution activity (Invoke API)
- **Insight Events**

#### CloudTrail Insights
- Enable CloudTrail Insights to detect unusual activity in your account:
	- inaccurate resource provisioning
	- hitting service limits
	- burst of AWS IAM actions
	- gaps in periodic maintenance activity
- CloudTrail Insights analyzes normal management events to create a baseline, and then continuously analyzes write events to detect unusual patterns

#### CloudTrail Events Retention
- Events are stored fro 90 days in CloudTrail
- To keep events beyond this period, log them to S3 and use Athena to analyze them


## AWS Config
- Helps with auditing and recording compliance of your AWS resources
- Helps record configurations and changes over time
- Questions that can be solved by AWS Config:
	- Is there unrestricted SSH access to my security groups?
	- Do my buckets have any public access?
	- How has my ALB configuration changed over time?
- You can receive alerts (SNS notifications) for any changes
- AWS Config is a per-region service
- Can be aggregated across regions and accounts
- Possibility of storing the configurations data in S3

### Config Rules
- Can use AWS managed config rules (over 75 rules to choose from)
- Can make custom config rules (must be defined in Lambda)
- Rules can be evaluated/triggered:
	- For each config change
	- And/or at regular time intervals
- AWS Config Rules does not prevent actions from happening (no deny)
- Pricing: no free tier, $0.003 per configuration item recorded per region, $0.001 per config rule evaluation per region

### Config Resource
- View compliance of a resource over time
- View configuration of a resource over time
- View CloudTrail API calls of a resource over time

### Rules - Remediations
- Automate remediation of non-compliant resources using SSM Automation Documents
- Use AWS Managed AUtomation Documents or create custom Automation Documents
- You can set Remediation Retries if the resource is still non compliant after automatic remediation

### Rules - Notifications
- Use EventBridge to trigger notifications when AWS resources are non-compliant
- Ability to send configuration changes and compliance state notifications to SNS (all events, you need to use SNS Filtering or filter at client-side)


## CloudWatch vs CloudTrail vs Confg
- CloudWatch
	- Performance monitoring
	- Events and Alerting
	- Log Aggregation and Analysis
- CloudTrail
	- Record API calls made within your account by everyone
	- Can define trails for specific resources
	- Global Service
- Config
	- Record configuration changes
	- Evaluate resources against compliance rules
	- Get timeline of changes and compliance
